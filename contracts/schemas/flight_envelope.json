{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Flight Envelope Schema",
  "description": "Schema for FlightStateEnvelope and FlightUpdateEnvelope used in Kafka topics",
  "definitions": {
    "position": {
      "type": "object",
      "required": ["lat", "lon"],
      "properties": {
        "lat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90,
          "description": "Latitude in degrees (WGS84)"
        },
        "lon": {
          "type": "number",
          "minimum": -180,
          "maximum": 180,
          "description": "Longitude in degrees (WGS84)"
        }
      }
    },
    "flightPayload": {
      "type": "object",
      "required": ["icao24", "position", "last_contact_unix"],
      "properties": {
        "icao24": {
          "type": "string",
          "pattern": "^[0-9a-f]{6}$",
          "description": "ICAO 24-bit address (hex, lowercase)"
        },
        "callsign": {
          "type": ["string", "null"],
          "description": "Aircraft callsign, may be null or empty"
        },
        "position": {
          "$ref": "#/definitions/position"
        },
        "altitude_m": {
          "type": ["number", "null"],
          "description": "Barometric altitude in meters"
        },
        "geo_altitude_m": {
          "type": ["number", "null"],
          "description": "Geometric altitude in meters"
        },
        "velocity_mps": {
          "type": ["number", "null"],
          "minimum": 0,
          "description": "Ground speed in meters per second"
        },
        "heading_deg": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 360,
          "exclusiveMaximum": true,
          "description": "True track in degrees [0, 360)"
        },
        "vertical_rate_mps": {
          "type": ["number", "null"],
          "description": "Vertical rate in meters per second (positive = climbing)"
        },
        "on_ground": {
          "type": "boolean",
          "description": "True if aircraft is on ground"
        },
        "squawk": {
          "type": ["string", "null"],
          "description": "Transponder code (e.g., '7700')"
        },
        "spi": {
          "type": "boolean",
          "description": "Special Purpose Indicator"
        },
        "time_position_unix": {
          "type": ["integer", "null"],
          "description": "Unix timestamp of position in seconds"
        },
        "last_contact_unix": {
          "type": "integer",
          "description": "Most recent message timestamp in seconds (freshness clock)"
        }
      }
    },
    "source": {
      "type": "object",
      "required": ["provider", "mode", "bbox", "poll_interval_s"],
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["opensky"],
          "description": "Data provider"
        },
        "mode": {
          "type": "string",
          "enum": ["live", "replay"],
          "description": "Ingestion mode"
        },
        "bbox": {
          "type": "object",
          "required": ["lat_min", "lat_max", "lon_min", "lon_max"],
          "properties": {
            "lat_min": {"type": "number"},
            "lat_max": {"type": "number"},
            "lon_min": {"type": "number"},
            "lon_max": {"type": "number"}
          }
        },
        "poll_interval_s": {
          "type": "integer",
          "minimum": 1,
          "description": "Poll interval in seconds"
        }
      }
    }
  },
  "oneOf": [
    {
      "title": "FlightStateEnvelope",
      "type": "object",
      "required": ["schema_version", "type", "produced_at", "source", "payload"],
      "properties": {
        "schema_version": {
          "type": "integer",
          "const": 1,
          "description": "Schema version for forward compatibility"
        },
        "type": {
          "type": "string",
          "const": "flight_state",
          "description": "Message type"
        },
        "produced_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when message was produced"
        },
        "source": {
          "$ref": "#/definitions/source"
        },
        "payload": {
          "$ref": "#/definitions/flightPayload"
        }
      }
    },
    {
      "title": "FlightUpdateEnvelope",
      "type": "object",
      "required": ["schema_version", "type", "produced_at", "source", "payload"],
      "properties": {
        "schema_version": {
          "type": "integer",
          "const": 1
        },
        "type": {
          "type": "string",
          "const": "flight_update",
          "description": "Message type"
        },
        "produced_at": {
          "type": "string",
          "format": "date-time"
        },
        "source": {
          "$ref": "#/definitions/source"
        },
        "payload": {
          "$ref": "#/definitions/flightPayload"
        }
      }
    }
  ]
}
